method size param = !{!}
method size returnType = int
method size body = 
!{
%body%

return %return%;
!}

method size body return = !{0 %%!}

method size body return default = !{ + sizeof(%type%)!}
method size body return string = !{ + (2 + %field%.Length)!}
method size body return struct = !{ + %field%.size()!}
method size body return array = !{ + s_%field%!}
method size body return array default = !{ + (sizeof(int) + sizeof(%type0%) * %field%.Count)!}
method size body body array default = !{ !}
method size body return map = !{ + s_%field%!}

method size body body = !{%%!}

method size body body array = !{
int s_%field% = sizeof(int);
{
    for (int %_i% = 0; %_i% < %field%.Count; %_i%++)
    {
        %!Larva.SubLarvae[0].TypeDefinition% %_e_name% = %field%[%_i%];
        
        %#method size body body#%_e_name%#%!Larva.SubLarvae[0].FullName%#%
        
        s_%field% += 0 %#method size body return#%_e_name%#%!Larva.SubLarvae[0].FullName%#%;
    }
}
!}

method size body body map = !{
int s_%field% = sizeof(int);
{
    foreach (var p in %field%)
    {
        %!Larva.SubLarvae[0].TypeDefinition% %_e_key% = p.Key;
        %!Larva.SubLarvae[0].TypeDefinition% %_e_value% = p.Value;
        
        %#method size body body#%_e_key%#%!Larva.SubLarvae[0].FullName%#%
        %#method size body body#%_e_value%#%!Larva.SubLarvae[1].FullName%#%
        
        s_%field% += 0 %#method size body return#%_e_key%#%!Larva.SubLarvae[0].FullName%#%
                       %#method size body return#%_e_value%#%!Larva.SubLarvae[1].FullName%#%;
    }
}
!}

method write param = !{ByteWriter byteWriter = null!}
method write returnType = byte[]

method write body =
!{
ByteWriter writer = byteWriter == null ? new ByteWriter() : byteWriter;

%% 

return writer.GetBuffer();
!}

method write body default = !{writer.Write(%field%);!}
method write body string = !{writer.WriteString(%field%);!}

method write body struct = !{ 
%field%.write(writer);
!}

method write body array = !{ 
// write array %field%
writer.Write(%field%.Count);

for (int %_i% = 0; %_i% < %field%.Count; %_i%++)
{
    %#method write body#%field%[%_i%]#%!Larva.SubLarvae[0].FullName%#%
}
!}

method write body map = !{ 
// write array %field%
writer.Write(%field%.Count);

foreach (var p in %field%)
{
    %!Larva.SubLarvae[0].TypeDefinition% %_e_key% = p.Key;
    %!Larva.SubLarvae[0].TypeDefinition% %_e_value% = p.Value;
        
    %#method write body#%_e_key%#%!Larva.SubLarvae[0].FullName%#%
    %#method write body#%_e_value%#%!Larva.SubLarvae[1].FullName%#%
}
!}

## read

method read param = !{byte[] bytes, ByteReader byteReader = null!}
method read returnType = void

method read body =
!{
ByteReader reader = byteReader == null ? new ByteReader(bytes) : byteReader;

%%
!}

method read body default = !{reader.Read(out %field%);!}
method read body string = !{%field% = reader.ReadString();!}

method read body struct = !{ 
%field% = new %!Larva.TypeDefinition%();
%field%.read(null, reader);
!}

method read body array = !{ 
// read array %field%
int s_%field%;
reader.Read(out s_%field%);
%field% = new %!Larva.TypeDefinition%(s_%field%);

for (int %_i% = 0; %_i% < s_%field%; %_i%++)
{
    %!Larva.SubLarvae[0].TypeDefinition% %_e_name%;        
    %#method read body#%_e_name%#%!Larva.SubLarvae[0].FullName%#%
    %field%.Add(%_e_name%);
}
!}

method read body map = !{ 
// read array %field%
int s_%field%;
reader.Read(out s_%field%);
%field% = new %!Larva.TypeDefinition%();

for (int %_i% = 0; %_i% < s_%field%; %_i%++)
{
    %!Larva.SubLarvae[0].TypeDefinition% %_e_key%;        
    %!Larva.SubLarvae[1].TypeDefinition% %_e_value%;       
     
    %#method read body#%_e_key%#%!Larva.SubLarvae[0].FullName%#%
    %#method read body#%_e_value%#%!Larva.SubLarvae[1].FullName%#%

    %field%[%_e_key%] = %_e_value%;
}

!}

